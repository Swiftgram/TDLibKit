name: CI

# Controls when the workflow will run
on:
  push:
    branches: [main]
    paths:
      - "version" # on version updates

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  TL_PARSER_REPO: https://github.com/Swiftgram/tl2swift

jobs:
  Build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2 

      - name: Resolve Deps
        run: xcodebuild -resolvePackageDependencies

      - name: Get commit & version
        run: |
            TDLIB_COMMIT=$(python3 scripts/parse_tdlib_version.py commit)
            TDLIB_VERSION=$(python3 scripts/parse_tdlib_version.py version)
            PACKAGE_VERSION=$(cat version | python3 -c "print(input().strip())")
            RELEASE_TAG=${PACKAGE_VERSION}-tdlib-${TDLIB_VERSION}-${TDLIB_COMMIT}

            echo "TDLIB_COMMIT=$TDLIB_COMMIT" >> $GITHUB_ENV
            echo "TDLIB_VERSION=$TDLIB_VERSION" >> $GITHUB_ENV
            echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
            echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Download td_api.tl
        run: wget https://raw.githubusercontent.com/tdlib/td/$TDLIB_COMMIT/td/generate/scheme/td_api.tl

      - name: Download Generator
        run: git clone https://github.com/Swiftgram/tl2swift

      - name: Run Generator
        working-directory: tl2swift
        run: swift run tl2swift ../td_api.tl ../Sources/TDLibKit/Generated $TDLIB_VERSION $TDLIB_COMMIT

      - name: Update Files
        run: |
          git add . || true
          git commit -m "[no ci] Version ${{ env.RELEASE_TAG }}" || true
          git push origin main || true

      - name: Remove previous release
        uses: dev-drprasad/delete-tag-and-release@85fa8bcea0379a6ada9bbfdcb0a9d24d58e1a0d7
        with:
          delete_release: true
          tag_name: ${{ env.RELEASE_TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release
        uses: softprops/action-gh-release@9729932bfb75c05ad1f6e3a729294e05abaa7001
        with:
          target_commitish: main
          tag_name: ${{ env.RELEASE_TAG }}
          files: ${{ env.ARTIFACT_PATH }}
          body: "TDLibKit based on TDLib-${{ env.TDLIB_VERSION }} commit [${{ env.TDLIB_COMMIT }}](${{ env.TDLIB_COMMIT_URL }})"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}